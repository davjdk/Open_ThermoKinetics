# Этап 2: Перехват и агрегация подопераций

## Цель этапа
Реализовать механизм перехвата вызовов `handle_request_cycle` и сбора информации о подоперациях.

## Задачи

### 2.1 Создание прокси-обёртки для handle_request_cycle
- Разработать механизм временной подмены метода `handle_request_cycle`
- Реализовать обёртку, которая:
  - Вызывает оригинальный метод
  - Собирает данные о запросе (target, operation, kwargs)
  - Замеряет время выполнения подоперации
  - Определяет статус выполнения (успешно/ошибка)
- Обеспечить восстановление оригинального метода после завершения операции

### 2.2 Структура данных подоперации
- Создать класс `SubOperationLog` для хранения информации о подоперации:
  - Номер шага (порядковый номер)
  - Название/тип подоперации (из OperationType или строка)
  - Целевой компонент (target)
  - Время начала и окончания
  - Статус выполнения (OK/Error)
  - Тип данных результата

### 2.3 Определение типа данных результата
- Реализовать функцию для определения типа данных из response['data']:
  - bool, int, float, str, dict, DataFrame, None
  - Специальная обработка ErrorDict (data с success/error)
- Анализ структуры ответа для определения успешности операции

### 2.4 Анализ статуса подоперации
- Логика определения успешности подоперации:
  - Наличие исключений
  - Анализ response['data'] на предмет success/error
  - Обработка различных форматов ответов

### 2.5 Интеграция с декоратором
- Модификация декоратора `@operation` для:
  - Активации перехвата `handle_request_cycle` в начале операции
  - Сбора всех подопераций в список
  - Деактивации перехвата по завершении операции
- Обеспечение корректной работы при вложенных вызовах

## Критерии готовности
- [ ] Все вызовы `handle_request_cycle` внутри декорированной операции перехватываются
- [ ] Корректно определяется тип данных результата подоперации
- [ ] Правильно определяется статус выполнения подоперации
- [ ] Сохраняется порядок выполнения подопераций
- [ ] Оригинальное поведение `handle_request_cycle` полностью сохраняется
- [ ] Прокси-обёртка не влияет на коммуникацию BaseSignals/BaseSlots

## Файлы для создания/изменения
- `src/core/log_aggregator/operation_logger.py` (расширение)
- `src/core/log_aggregator/sub_operation_log.py`

## Примечания
Важно обеспечить:
- Потокобезопасность при работе с прокси
- Минимальное влияние на производительность
- Корректное восстановление оригинального метода даже при исключениях
