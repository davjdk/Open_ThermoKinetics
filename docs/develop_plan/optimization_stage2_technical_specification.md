# Техническое задание: Этап 2 - Средние изменения для оптимизации производительности MODEL_BASED_CALCULATION

## Общая информация

**Документ:** Этап 2 реализации OPTIMIZATION_PERFORMANCE_ANALYSIS.md  
**Ожидаемые сроки:** 3-4 часа  
**Ожидаемый результат:** Ускорение в 4-8 раз, утилизация CPU 70-85%  
**Сложность:** Средняя  

## Цели и задачи

### Основная цель
Реализовать средний уровень оптимизации производительности MODEL_BASED_CALCULATION путем добавления новых алгоритмов оптимизации с ручной настройкой параметров пользователем.

### Ключевые задачи
1. **Интеграция dual_annealing** как третьего метода оптимизации
2. **Расширение UI** для поддержки новых возможностей
3. **Комплексное тестирование** новой функциональности

## Детальное описание задач

### Задача 1: Интеграция Dual Annealing алгоритма

#### 1.1 Добавление dual_annealing в core/app_settings.py

**Файл:** `src/core/app_settings.py`

**Действия:**
- Добавить "dual_annealing" в список OPTIMIZATION_METHODS
- Создать конфигурацию DUAL_ANNEALING_DEFAULT_KWARGS
- Добавить валидационные диапазоны DUAL_ANNEALING_PARAM_RANGES

**Конкретная реализация:**
```python
# После существующих OPTIMIZATION_METHODS добавить:
OPTIMIZATION_METHODS = [
    "differential_evolution",
    "basinhopping", 
    "dual_annealing",  # НОВЫЙ МЕТОД
]

# Новые константы:
DUAL_ANNEALING_DEFAULT_KWARGS = {
    "maxiter": 1000,
    "initial_temp": 5230.0,
    "restart_temp_ratio": 2e-05,
    "visit": 2.62,
    "accept": -5.0,
    "maxfun": 1000000,
    "seed": None,
    "no_local_search": False,  # Важно для точности
    "callback": None,
    "x0": None,
}

DUAL_ANNEALING_PARAM_RANGES = {
    "maxiter": (100, 5000),
    "initial_temp": (1000.0, 10000.0),
    "restart_temp_ratio": (1e-06, 1e-03),
    "visit": (2.0, 3.0),
    "accept": (-10.0, 0.0),
    "maxfun": (100000, 10000000),
}
```

#### 1.2 Обновление ModelBasedScenario для поддержки dual_annealing

**Файл:** `src/core/calculation_scenarios.py`

**Действия:**
- Добавить импорт `from scipy.optimize import dual_annealing`
- Расширить метод run_optimization() для обработки dual_annealing
- Адаптировать обработку результатов

**Критические моменты:**
- dual_annealing имеет другой интерфейс callbacks по сравнению с DE и basinhopping
- Нужна корректная обработка bounds для dual_annealing формата
- Результат возвращается как OptimizeResult объект

#### 1.3 Обновление GUI компонентов

**Файлы:** 
- `src/gui/main_tab/sub_sidebar/model_based/calculation_settings_dialogs.py`
- `src/gui/main_tab/sub_sidebar/model_based/calculation_controls.py`

**Действия:**
- Добавить dual_annealing в ComboBox выбора метода
- Создать CalculationSettingsDualAnnealingDialog
- Обновить обработчики событий для нового метода

### Задача 2: Расширение пользовательского интерфейса

#### 2.1 Обновление CalculationControls

**Файл:** `src/gui/main_tab/sub_sidebar/model_based/calculation_controls.py`

**Действия:**
- Добавить поддержку выбора dual_annealing метода
- Обновить обработчики событий для нового метода

#### 2.2 Создание DualAnnealingSettingsDialog

**Файл:** `src/gui/main_tab/sub_sidebar/model_based/calculation_settings_dialogs.py`

**Действия:**
- Создать диалог настроек для dual_annealing
- Добавить валидацию параметров

### Задача 3: Комплексное тестирование

#### 3.1 Модульные тесты

**Файл:** `tests/test_optimization_stage2.py` (новый файл)

**Тестовые случаи:**
- Проверка корректности dual_annealing интеграции
- Тестирование UI компонентов

```python
import pytest
import multiprocessing as mp
from src.core.calculation_scenarios import ModelBasedScenario

class TestDualAnnealingIntegration:
    """Тесты интеграции dual_annealing"""
    
    def test_dual_annealing_optimization(self):
        """Тест базовой функциональности dual_annealing"""
        # Тест успешного выполнения оптимизации
        pass
        
    def test_dual_annealing_parameters(self):
        """Тест валидации параметров dual_annealing"""
        # Тест корректности переданных параметров
        pass
```

#### 3.2 Интеграционные тесты

**Файл:** `tests/test_model_based_integration_stage2.py` (новый файл)

**Тестовые сценарии:**
- Полный цикл оптимизации с dual_annealing

#### 3.3 Тесты производительности

**Файл:** `tests/test_performance_benchmarks.py` (новый файл)

**Бенчмарки:**
- Сравнение времени выполнения до и после оптимизации
- Измерение утилизации CPU для разных методов
- Валидация ускорения в 4-8 раз

## Технические требования

### Требования к производительности
- **Утилизация CPU:** 70-85% при использовании всех доступных ядер
- **Ускорение:** В 4-8 раз по сравнению с первоначальной реализацией
- **Память:** Не более 2 GB дополнительного использования памяти
- **Отзывчивость UI:** GUI должен оставаться отзывчивым во время оптимизации

### Требования к совместимости
- **Python версии:** 3.8+
- **Зависимости:** Все новые зависимости должны быть добавлены в pyproject.toml
- **ОС:** Windows, Linux, macOS
- **Обратная совместимость:** Существующие конфигурации должны продолжать работать

### Требования к качеству кода
- **Покрытие тестами:** Минимум 85% для новых модулей
- **Документация:** Полное покрытие docstrings в стиле Google
- **Типизация:** Использование type hints для всех публичных API
- **Линтинг:** Соответствие правилам black, isort, flake8

## Структура файлов

### Новые файлы
```
tests/
  test_optimization_stage2.py         # Модульные тесты
  test_model_based_integration_stage2.py  # Интеграционные тесты
  test_performance_benchmarks.py      # Бенчмарки производительности

docs/
  develop_plan/
    optimization_stage2_results.md    # Отчет о результатах
```

### Модифицируемые файлы
```
src/
  core/
    app_settings.py                   # Новые константы и конфигурации
    calculation_scenarios.py          # Интеграция новых возможностей  gui/
    main_tab/sub_sidebar/model_based/
      model_based_panel.py           # Поддержка dual_annealing
      calculation_controls.py        # Поддержка нового метода
      calculation_settings_dialogs.py # Новый диалог dual_annealing
```

## План выполнения

### Этап 2.1: Подготовка инфраструктуры (1 час)
1. Обновление `app_settings.py` с новыми константами
2. Настройка базовой структуры тестов

### Этап 2.2: Реализация основного функционала (1-2 часа)
1. Интеграция dual_annealing в ModelBasedScenario

### Этап 2.3: Интеграция с UI (1 час)
1. Обновление ModelBasedPanel
2. Создание DualAnnealingSettingsDialog
3. Обновление CalculationControls

### Этап 2.4: Тестирование и отладка (1 час)
1. Написание и запуск модульных тестов
2. Интеграционное тестирование
3. Бенчмарки производительности
4. Исправление найденных проблем

### Этап 2.5: Документация и финализация (30 минут)
1. Обновление документации API
2. Создание отчета о результатах
3. Подготовка к следующему этапу

## Критерии успеха

### Функциональные критерии
- ✅ dual_annealing успешно интегрирован и работает
- ✅ GUI поддерживает новый метод оптимизации
- ✅ Все тесты проходят успешно

### Критерии производительности
- ✅ Утилизация CPU 70-85% (по сравнению с 20-30% до оптимизации)
- ✅ Ускорение в 4-8 раз по времени выполнения

### Критерии качества
- ✅ Покрытие тестами >= 85%
- ✅ Все новые модули имеют полную документацию
- ✅ Код соответствует стандартам проекта
- ✅ Обратная совместимость сохранена

## Риски и их митигация

### Риск 1: Производительность dual_annealing ниже ожидаемой
**Митигация:** Тщательная настройка параметров и сравнительное тестирование с DE и basinhopping

### Риск 2: Проблемы интеграции с существующим UI
**Митигация:** Тщательное планирование изменений, поэтапная интеграция, тестирование на каждом шаге

## Заключение

Этап 2 представляет собой сбалансированное расширение функциональности, которое должно дать существенное ускорение производительности при умеренной сложности реализации. Ключевые преимущества:

1. **Новый алгоритм оптимизации** (dual_annealing) для лучшего качества решений
2. **Улучшенный UX** с расширенным выбором методов оптимизации

После успешной реализации этапа 2 система будет готова к более глубоким оптимизациям этапа 3, включающим параллелизацию целевой функции и Numba оптимизации.
