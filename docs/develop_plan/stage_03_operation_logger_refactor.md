# Этап 3: Рефакторизация OperationLogger

## Цель этапа
Переработать класс `OperationLogger` для поддержки новой декораторной архитектуры с автоматическим отображением агрегированных метрик.

## Задачи этапа

### 3.1 Обновление интерфейса OperationLogger
- Сохранить существующее имя класса для обратной совместимости
- Упростить публичный API, оставив только необходимые методы
- Интегрировать поддержку декоратора `@operation`
- Обеспечить thread-local хранение контекста операций

### 3.2 Реализация стека операций
- Внедрить механизм отслеживания вложенных операций
- Реализовать корректное управление иерархией вызовов
- Обеспечить правильное закрытие операций при исключениях
- Сохранить контекст операций между вложенными вызовами

### 3.3 Система сбора метрик
- Автоматический сбор временных метрик (start_time, end_time, duration)
- Подсчёт количества вызовов операций и подопераций
- Сбор метрик файловых операций (количество изменённых файлов)
- Интеграция пользовательских метрик через `add_metric()`

### 3.4 Интеграция с агрегированным выводом
- Автоматический вызов генерации таблицы после каждой операции
- Передача собранных метрик в компонент форматирования
- Настройка формата вывода через конфигурацию
- Поддержка отключения автоматического вывода

## Новые методы и свойства

### Основные методы
```python
class OperationLogger:
    def start_operation(self, operation_name: str, **context) -> None:
        """Начать новую операцию или увеличить счётчик вложенной"""
        
    def end_operation(self, status: str = "SUCCESS", error_info: dict = None) -> None:
        """Завершить текущую операцию и вывести агрегированную таблицу"""
        
    def add_metric(self, key: str, value: Any) -> None:
        """Добавить пользовательскую метрику к текущей операции"""
        
    def get_current_operation(self) -> Optional[dict]:
        """Получить контекст текущей операции"""
```

### Thread-local контекст
```python
class OperationContext:
    operation_stack: List[dict]  # Стек активных операций
    current_metrics: dict        # Метрики текущей операции
    start_times: dict           # Времена начала операций
```

### 3.5 Обработка ошибок операций
- Автоматическое помечивание операции как ERROR при исключении
- Сбор информации об ошибке (тип, сообщение, traceback)
- Интеграция с интерфейсом `OperationErrorHandler`
- Корректное завершение операции даже при ошибках

## Интеграция с существующими компонентами

### Связь с OperationAggregator
- Переключение на explicit mode агрегатора
- Передача событий start/end операций напрямую
- Отключение auto mode для избежания конфликтов
- Использование агрегатора только для группировки данных

### Интеграция с конфигурацией
- Считывание параметров временных окон из app_settings
- Поддержка флагов включения/отключения таблиц ASCII
- Настройка детализации вывода операций
- Конфигурация обработки ошибок

## Ожидаемые результаты
- Обновлённый класс `OperationLogger` с поддержкой декораторов
- Автоматическое отображение таблиц после каждой операции
- Корректная обработка вложенных операций и ошибок
- Сохранение потокобезопасности и производительности

## Критерии готовности
- `OperationLogger` корректно работает с декоратором `@operation`
- Вложенные операции агрегируются в родительские без дублирования
- После каждой операции автоматически выводится таблица метрик
- Ошибки операций корректно обрабатываются и отображаются

## Тестирование
- Тест базового цикла операции (start → метрики → end → таблица)
- Тест агрегации вложенных операций
- Тест обработки исключений в операциях
- Тест работы в многопоточной среде
- Тест интеграции с конфигурационными параметрами

## Миграция
- Обеспечить совместимость с существующими вызовами
- Постепенный переход с ручного логирования на декораторы
- Сохранение работоспособности во время миграции
- Документация изменений для команды разработки
