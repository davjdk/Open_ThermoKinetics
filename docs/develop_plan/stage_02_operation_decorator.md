# Этап 2: Создание нового декоратора @operation

## Цель этапа
Разработать и внедрить декоратор `@operation` для явного обозначения границ операций с автоматической интеграцией в систему логирования.

## Задачи этапа

### 2.1 Реализация базового декоратора
- Создать функцию-декоратор `@operation` в модуле logger_handler
- Интегрировать декоратор с существующим `OperationLogger`
- Обеспечить автоматический вызов `start_operation()` и `end_operation()`
- Реализовать передачу контекста операции (имя, параметры)

### 2.2 Обработка исключений в декораторе
- Добавить блок try/except для перехвата ошибок операций
- Обеспечить корректную фиксацию статуса операции при ошибках
- Сохранить информацию об исключении для последующей обработки
- Гарантировать, что исключения не теряются после логирования

### 2.3 Поддержка вложенных операций
- Реализовать логику обнаружения вложенных вызовов операций
- Обеспечить корректное увеличение счётчиков для родительской операции
- Предотвратить создание отдельных записей для дочерних операций
- Сохранить иерархическую структуру для детализированного отчёта

### 2.4 Сохранение метаданных методов
- Обеспечить совместимость с PyQt @pyqtSlot декораторами
- Сохранить сигнатуры и документацию оригинальных методов
- Использовать functools.wraps для корректного оборачивания
- Тестировать совместимость с другими декораторами

## Технические требования

### Интерфейс декоратора
```python
@operation
def some_operation_method(self, *args, **kwargs):
    # Бизнес-логика операции
    pass

# Или с параметрами
@operation(operation_type="CUSTOM_OPERATION")
def another_method(self, *args, **kwargs):
    # Бизнес-логика
    pass
```

### Интеграция с OperationLogger
- Автоматический вызов `operation_logger.start_operation(operation_name)`
- Сбор метрик времени выполнения
- Фиксация статуса завершения (SUCCESS/ERROR)
- Передача информации об исключениях

### Потокобезопасность
- Использование thread-local storage для контекста операций
- Изоляция счётчиков между потоками
- Корректная работа в многопоточной среде PyQt

## Ожидаемые результаты
- Рабочий декоратор `@operation` в модуле logger_handler
- Автоматическое логирование для помеченных методов
- Корректная обработка вложенных операций и исключений
- Сохранение совместимости с существующими декораторами

## Критерии готовности
- Декоратор успешно оборачивает методы без нарушения функциональности
- Вложенные операции корректно агрегируются в родительские
- Исключения перехватываются и логируются без потери информации
- Сохранена совместимость с PyQt сигналами

## Тестирование
- Тест простой операции с декоратором
- Тест вложенных операций (A вызывает B)
- Тест обработки исключений внутри операции
- Тест совместимости с PyQt слотами
- Тест потокобезопасности при параллельных вызовах
