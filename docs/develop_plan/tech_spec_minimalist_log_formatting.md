# Техническое задание: Минималистичная визуализация агрегированных логов

## Общие сведения

**Дата создания**: 17 июня 2025  
**Версия**: 1.0  
**Приоритет**: Средний  
**Статус**: К разработке  

**Цель**: Упрощение и минимизация визуального представления таблиц в агрегированных логах операций для улучшения читаемости и снижения информационного шума.

---

## Текущее состояние

### Анализ существующего формата

**Целевые файлы**:
- `src/core/log_aggregator/table_formatter.py` - основной форматтер таблиц
- `src/core/log_aggregator/aggregated_operation_logger.py` - менеджер вывода
- `logs/aggregated_operations.log` - выходной файл логов

**Текущий формат вывода**:
```
================================================================================
Operation "TO_A_T" – STARTED (id=3, 2025-06-17 00:47:51)

+--------+----------------------+-----------+--------------------+----------+-----------+
|   Step | Sub-operation        | Target    | Result data type   |  Status  |   Time, s |
+========+======================+===========+====================+==========+===========+
|      1 | CHECK_EXPERIMENT_... | file_data | bool               |    OK    |     0.001 |
+--------+----------------------+-----------+--------------------+----------+-----------+

SUMMARY: steps 1, successful 1, with errors 0, total time 0.001 s.
Operation "TO_A_T" – COMPLETED (status: successful)
================================================================================
```

**Проблемы текущего формата**:
1. Избыточная декоративная рамка (`================================================================================`)
2. Громоздкий заголовок без информации о модуле-источнике
3. Дублирование информации в footer о завершении операции
4. Отсутствие разделения между таблицами
5. Избыточная визуальная нагрузка

---

## Требования к новому формату

### Функциональные требования

**REQ-001: Минималистичный заголовок**
- ДОЛЖЕН содержать информацию о модуле-источнике операции
- ДОЛЖЕН содержать строку кода, откуда вызывается операция  
- ДОЛЖЕН содержать имя операции в кавычках
- ДОЛЖЕН содержать ID операции и timestamp
- НЕ ДОЛЖЕН содержать декоративных элементов

**Формат заголовка**:
```
модуль: строка_откуда_вызывается_код "ИМЯ_ОПЕРАЦИИ" (id=3, 2025-06-17 00:47:51)
```

**REQ-002: Упрощенная таблица**
- ДОЛЖНА сохранять текущую структуру столбцов
- ДОЛЖНА использовать минимальное табличное оформление
- НЕ ДОЛЖНА содержать избыточных границ и декорации
- ДОЛЖНА быть читаемой в текстовом формате

**REQ-003: Разделение таблиц**
- Каждая таблица ДОЛЖНА отделяться двумя переводами строк (`\n\n`)
- НЕ ДОЛЖНО быть дополнительных декоративных разделителей

**REQ-004: Удаление footer**
- НЕ ДОЛЖНА выводиться информация о завершении операции
- НЕ ДОЛЖНА дублироваться информация о статусе
- ДОЛЖНА сохраняться только SUMMARY строка

### Нефункциональные требования

**REQ-005: Обратная совместимость**
- Изменения ДОЛЖНЫ быть конфигурируемыми
- ДОЛЖНА быть возможность переключения между форматами
- НЕ ДОЛЖНА нарушаться существующая функциональность

**REQ-006: Производительность**
- Изменения НЕ ДОЛЖНЫ влиять на производительность логирования
- ДОЛЖНЫ сохраняться текущие оптимизации форматирования

---

## Целевой формат вывода

### Пример нового формата

**Одиночная операция**:
```
calculations_data.py:127 "ADD_REACTION" (id=3, 2025-06-17 00:47:51)

   | Step | Sub-operation        | Target    | Result data type | Status | Time, s |
   | ---- | -------------------- | --------- | ---------------- | ------ | ------- |
   | 1    | CHECK_EXPERIMENT_... | file_data | bool             | OK     | 0.001   |
   | 2    | GET_DF_DATA          | file_data | DataFrame        | OK     | 0.003   |

SUMMARY: steps 2, successful 2, with errors 0, total time 0.004 s.


file_data.py:89 "LOAD_FILE" (id=4, 2025-06-17 00:48:15)

   | Step | Sub-operation  | Target    | Result data type | Status | Time, s |
   | ---- | -------------- | --------- | ---------------- | ------ | ------- |
   | 1    | VALIDATE_FILE  | file_data | bool             | OK     | 0.002   |
   | 2    | PARSE_CSV_DATA | file_data | DataFrame        | OK     | 0.015   |

SUMMARY: steps 2, successful 2, with errors 0, total time 0.017 s.

```

### Элементы формата

**Заголовок операции**:
- `модуль.py:номер_строки` - точное местоположение вызова
- `"ИМЯ_ОПЕРАЦИИ"` - название операции в кавычках
- `(id=X, YYYY-MM-DD HH:mm:ss)` - идентификатор и timestamp

**Таблица**:
- Простые ASCII символы для границ
- Выравнивание по левому краю для текста, по правому для чисел
- Один символ `-` для горизонтальных линий
- Один символ `|` для вертикальных линий

**Разделитель**:
- Двойной перевод строки `\n\n` между операциями
- Никаких дополнительных символов

---

## Техническая реализация

### Модификация компонентов

**1. OperationTableFormatter** (`src/core/log_aggregator/table_formatter.py`):

```python
class OperationTableFormatter:
    def __init__(self, 
                 table_format: str = "simple",  # Изменить с "grid" на "simple"
                 max_cell_width: int = 50,
                 minimalist_mode: bool = True):  # Новый параметр
```

**Методы для модификации**:
- `format_operation_log()` - изменение общей структуры
- `_format_operation_header()` - новый формат заголовка
- `_format_sub_operations_table()` - упрощенная таблица
- `_format_operation_footer()` - удаление footer

**2. Добавление информации о модуле**:

```python
@dataclass
class OperationLog:
    operation_name: str
    start_time: Optional[float] = None
    end_time: Optional[float] = None
    status: str = "running"
    execution_time: Optional[float] = None
    exception_info: Optional[str] = None
    sub_operations: List[SubOperationLog] = field(default_factory=list)
    # Новые поля
    source_module: Optional[str] = None      # Имя модуля
    source_line: Optional[int] = None        # Номер строки
    caller_info: Optional[str] = None        # Дополнительная информация о вызывающем коде
```

**3. OperationLogger** (`src/core/log_aggregator/operation_logger.py`):

```python
import inspect
import traceback

class OperationLogger:
    def __init__(self, operation_name: str):
        self.operation_log = OperationLog(operation_name)
        self._capture_caller_info()  # Новый метод
    
    def _capture_caller_info(self):
        """Захват информации о вызывающем коде."""
        frame = inspect.currentframe()
        try:
            # Поднимаемся по стеку до декорированной функции
            for _ in range(3):  # @operation -> wrapper -> __init__
                frame = frame.f_back
                if frame is None:
                    break
            
            if frame:
                filename = frame.f_code.co_filename
                line_number = frame.f_lineno
                module_name = Path(filename).name
                
                self.operation_log.source_module = module_name
                self.operation_log.source_line = line_number
        finally:
            del frame
```

### Конфигурация

**Добавление в MetaOperationConfig**:

```python
META_OPERATION_CONFIG = {
    "enabled": True,
    "formatting": {
        "mode": "minimalist",  # Новый режим
        "table_format": "simple",
        "show_decorative_borders": False,
        "show_completion_footer": False,
        "table_separator": "\n\n",
        "include_source_info": True
    },
    # ...existing config...
}
```

---

## План реализации

### Этап 1: Базовая инфраструктура (2-3 часа)

**Задачи**:
1. Добавить новые поля в `OperationLog`
2. Реализовать захват информации о вызывающем коде в `OperationLogger`
3. Добавить конфигурационные параметры

**Критерии готовности**:
- Информация о модуле и строке корректно захватывается
- Конфигурация позволяет переключение между режимами

### Этап 2: Форматирование заголовков (1-2 часа)

**Задачи**:
1. Модифицировать `_format_operation_header()` для нового формата
2. Реализовать extraction модуля и номера строки
3. Тестирование корректности заголовков

**Критерии готовности**:
- Заголовки отображаются в формате `модуль.py:строка "ОПЕРАЦИЯ" (id=X, timestamp)`
- Корректно работает fallback для случаев без source info

### Этап 3: Упрощение таблиц (1-2 часа)

**Задачи**:
1. Изменить `table_format` с "grid" на "simple"
2. Удалить декоративные элементы
3. Настроить разделители между таблицами

**Критерии готовности**:
- Таблицы используют минимальное ASCII оформление
- Между таблицами используется `\n\n`

### Этап 4: Удаление footer (30 минут)

**Задачи**:
1. Модифицировать `format_operation_log()` для пропуска footer
2. Сохранить только SUMMARY блок

**Критерии готовности**:
- Footer "Operation COMPLETED" не выводится
- SUMMARY строка сохраняется

### Этап 5: Тестирование и отладка (1-2 часа)

**Задачи**:
1. Создать unit тесты для нового формата
2. Протестировать на реальных логах
3. Проверить производительность

**Критерии готовности**:
- Все существующие тесты проходят
- Новый формат корректно генерируется
- Нет деградации производительности

---

## Критерии приемки

### Функциональные критерии

1. **Заголовки**: Содержат модуль, строку, имя операции, ID и timestamp
2. **Таблицы**: Используют минималистичное ASCII оформление
3. **Разделители**: Двойной перевод строки между операциями
4. **Footer**: Отсутствие completion messages, сохранение SUMMARY
5. **Конфигурируемость**: Возможность переключения режимов

### Технические критерии

1. **Обратная совместимость**: Старый формат доступен через конфигурацию
2. **Производительность**: Нет деградации времени логирования
3. **Расширяемость**: Легко добавлять новые элементы формата
4. **Отказоустойчивость**: Graceful fallback при отсутствии source info

### Качественные критерии

1. **Читаемость**: Логи легко сканируются визуально
2. **Компактность**: Снижение объема текста на 30-40%
3. **Информативность**: Сохранение всей важной информации
4. **Последовательность**: Единообразный формат для всех операций

---

## Риски и ограничения

### Технические риски

**РИСК-001: Неточный захват caller info**
- **Описание**: Сложность определения точного места вызова операции
- **Митигация**: Использование inspect.stack() с fallback значениями
- **Вероятность**: Средняя

**РИСК-002: Производительность inspect**
- **Описание**: Overhead от inspect операций
- **Митигация**: Кэширование, ленивые вычисления
- **Вероятность**: Низкая

### Ограничения

1. **Точность source info**: Зависит от стека вызовов Python
2. **Форматирование**: Ограничено ASCII символами для совместимости
3. **Конфигурация**: Требует restart для применения изменений

---

## Успешная реализация

По завершении реализации система агрегированного логирования должна:

1. **Генерировать читаемые логи** с минимальным визуальным шумом
2. **Предоставлять точную информацию** о местоположении операций в коде
3. **Сохранять производительность** без деградации скорости логирования
4. **Обеспечивать гибкость** через конфигурационные параметры

**Ожидаемый результат**: Повышение эффективности анализа логов операций при сохранении всей критической информации о выполнении системы.
