# Этап 1: Анализ требований и описание задачи

## Описание задачи

Необходимо разработать новую стратегию детектирования мета-операций **BaseSignalsMetaBurst** для системы агрегированного логирования операций. Данная стратегия предназначена для выявления "всплесков" подопераций, инициированных модулем `base_signals`, происходящих в пределах одного временного окна (по умолчанию 100 мс). Это позволит группировать серию быстрых вызовов из `base_signals` в одну логическую мета-операцию, повышая читаемость логов и облегчая анализ паттернов работы системы.

## Контекст и предпосылки

### Текущая архитектура системы логирования

В системе анализа кинетики твердофазных реакций реализована **система агрегированного логирования операций** с автоматическим захватом подопераций через декоратор `@operation`. Система включает:

- **OperationLogger** - основной оркестратор с автоматическим захватом `handle_request_cycle` вызовов
- **MetaOperationDetector** - координатор множественных стратегий детекции кластеров
- **Существующие стратегии**: TimeWindowStrategy, TargetClusterStrategy, NameSimilarityStrategy, SequenceCountStrategy

### Архитектура межмодульного взаимодействия

Система использует **сигнально-слотовую архитектуру** с централизованной диспетчеризацией:
- **BaseSignals** - центральный диспетчер с `request_signal`/`response_signal`
- **BaseSlots** - базовый класс для всех модулей с `handle_request_cycle()` методом
- **Модульная структура**: каждый модуль имеет `actor_name` (например, "calculations_data", "file_data", "main_window")

### Потребность в BaseSignals-специфичной детекции

**Проблема**: Существующие стратегии группируют операции по времени (TimeWindow) или целевому модулю (TargetCluster), но не учитывают специфику **внутренних операций диспетчера BaseSignals**. При интенсивном межмодульном взаимодействии возникают "всплески" операций, которые логически связаны через BaseSignals, но разбросаны по времени и разным целевым модулям.

**Решение**: Специализированная стратегия для выявления кластеров операций, инициированных BaseSignals механизмом, независимо от их target и с более широким временным окном.

## Детальный анализ функциональных требований

### FR-1: Идентификация base_signals операций

**Требование**: Стратегия должна корректно идентифицировать операции, инициированные механизмом BaseSignals.

**Критерии идентификации**:
1. **По actor_name**: Операции, где `actor_name` содержит паттерны, связанные с BaseSignals
2. **По целевому модулю**: Операции, инициированные известными BaseSignals модулями  
3. **По типу операции**: Специфичные операции межмодульного взаимодействия

**Техническая реализация**: 
- Анализ поля `SubOperationLog.target` и `SubOperationLog.operation_name`
- Поскольку текущая структура `SubOperationLog` не содержит прямого поля `source_module`, идентификация осуществляется по косвенным признакам:
  - Паттернам имен операций (например, операции диспетчеризации)
  - Известным actor_name модулей, использующих BaseSignals
  - Временным паттернам характерным для BaseSignals операций

### FR-2: Временное кластерирование с адаптивным окном

**Требование**: Группировка операций в пределах настраиваемого временного окна.

**Параметры конфигурации**:
- `window_ms`: Размер временного окна (по умолчанию 100 мс)
- `min_cluster_size`: Минимальное количество операций для формирования кластера (по умолчанию 2)
- `max_gap_ms`: Максимальный разрыв между операциями в кластере (по умолчанию 50 мс)

**Алгоритм кластеризации**:
1. Для каждой BaseSignals операции найти все смежные BaseSignals операции в пределах `window_ms`
2. Проверить, что разрывы между операциями не превышают `max_gap_ms`
3. Сформировать кластер, если количество операций ≥ `min_cluster_size`

### FR-3: Обработка шумовых операций

**Требование**: Фиксация "шумовых" операций, попадающих во временное окно кластера.

**Критерии шумовых операций**:
- Операции не-BaseSignals типа, стартующие в пределах временного окна кластера
- Операции с временем выполнения, пересекающимся с кластером BaseSignals

**Информация о шуме**:
- Количество шумовых операций
- Типы шумовых операций (краткое описание)
- Процентное соотношение шума к полезным операциям

### FR-4: Генерация мета-операционного резюме

**Требование**: Формирование информативного описания для каждого кластера.

**Структура резюме**:
```
BaseSignals Burst: {count} operations in {duration}ms
├─ Core operations: {base_signals_count} BaseSignals calls
├─ Noise operations: {noise_count} ({noise_percentage}%)
├─ Actors involved: {actor_list}
└─ Duration: {start_time} - {end_time} ({total_duration}ms)
```

**Компоненты резюме**:
- Общая статистика кластера (количество операций, продолжительность)
- Список участвующих модулей (`actor_name`)
- Соотношение полезных и шумовых операций
- Временные границы кластера

### FR-5: Система отключения и конфигурации

**Требование**: Полная отключаемость стратегии без влияния на основное логирование.

**Уровни конфигурации**:
1. **Глобальное отключение**: `enabled: false` - стратегия не регистрируется
2. **Условное отключение**: `min_operations_threshold` - стратегия активна только при превышении порога
3. **Фильтрация модулей**: `excluded_actors` - исключение определенных модулей из анализа

## Анализ нефункциональных требований

### NFR-1: Производительность

**Требования к производительности**:
- Накладные расходы на детекцию: не более 5% от времени основного логирования
- Время анализа одной операции: не более 1 мс
- Память на кластер: не более 1 КБ

**Стратегии оптимизации**:
- Ленивая оценка: анализ только при наличии BaseSignals операций
- Кэширование результатов идентификации модулей
- Использование эффективных структур данных (set для поиска, deque для временных окон)

### NFR-2: Надежность и отказоустойчивость

**Требования к надежности**:
- Ошибки стратегии не должны влиять на основное логирование
- Некорректная конфигурация должна приводить к отключению стратегии с предупреждением
- Исключения в процессе детекции логируются, но не прерывают обработку

**Механизмы обеспечения**:
- Валидация конфигурации при инициализации
- Try-catch блоки вокруг всех операций детекции
- Fallback к отсутствию кластеризации при ошибках

### NFR-3: Совместимость

**Требования к совместимости**:
- Обратная совместимость с существующими форматтерами логов
- Неконфликтность с другими стратегиями детекции
- Поддержка всех существующих форматов вывода (compact, detailed, table, JSON)

**Стратегии обеспечения**:
- Использование стандартных интерфейсов `MetaOperationStrategy`
- Уникальные идентификаторы мета-операций (`base_signals_burst_*`)
- Стандартизированные названия стратегии ("BaseSignalsMetaBurst")

### NFR-4: Сопровождаемость

**Требования к сопровождаемости**:
- Подробное логирование работы стратегии в debug режиме
- Четкая структура кода с документированными методами
- Конфигурационные параметры с описательными именами

## Архитектурные ограничения и предположения

### Ограничения существующей системы

1. **Отсутствие source_module**: В текущей структуре `SubOperationLog` нет прямого поля для идентификации исходного модуля
2. **Асинхронность операций**: Время начала операций может не отражать реальную последовательность выполнения
3. **Ограниченный контекст**: Доступ только к информации в рамках одной основной операции (`OperationLog`)

### Предположения

1. **Стабильные actor_name**: Имена модулей не изменяются в рамках одной сессии
2. **Временная точность**: Timestamps достаточно точны для определения временных окон в миллисекундах
3. **Ограниченная вложенность**: BaseSignals операции не образуют глубокой рекурсии

### Технические ограничения

1. **Минимальная модификация существующего кода**: Стратегия должна работать с текущими структурами данных
2. **Thread-safety**: Стратегия может вызываться из разных потоков одновременно
3. **Память**: Ограничения на хранение промежуточных данных кластеризации

## Базовые сценарии использования

### Сценарий 1: Интенсивное межмодульное взаимодействие

**Контекст**: Операция загрузки файла с последующей деконволюцией
**Последовательность**:
1. MainWindow → FileData (load_file)
2. FileData → CalculationsData (get_experiment_info)
3. CalculationsData → SeriesData (check_series_exists)
4. MainWindow → PlotCanvas (update_plot_data)
5. PlotCanvas → CalculationsDataOperations (highlight_reaction)

**Ожидаемый результат**: Группировка операций 1-5 в мета-операцию "BaseSignals Burst: 5 operations in 150ms"

### Сценарий 2: Смешанные операции с шумом

**Контекст**: Пользовательское взаимодействие во время фоновых расчетов
**Последовательность**:
1. MainWindow → FileData (load_file) [BaseSignals]
2. BackgroundThread → Database (save_intermediate) [шум]
3. FileData → CalculationsData (store_data) [BaseSignals]
4. FileData → PlotCanvas (plot_data) [BaseSignals]
5. LoggingSystem → FileSystem (write_log) [шум]

**Ожидаемый результат**: Кластер из операций 1, 3, 4 с пометкой о 2 шумовых операциях (40% шума)

### Сценарий 3: Недостаточное количество операций

**Контекст**: Единичная операция запроса данных
**Последовательность**:
1. MainWindow → CalculationsData (get_value) [BaseSignals]

**Ожидаемый результат**: Кластер не формируется (< min_cluster_size), операция остается индивидуальной

### Сценарий 4: Операции с большими временными разрывами

**Контекст**: Операции разделены длительными вычислениями
**Последовательность**:
1. MainWindow → Calculations (start_deconvolution) [BaseSignals, t=0ms]
2. [длительная пауза 500ms]
3. Calculations → CalculationsData (save_results) [BaseSignals, t=500ms]

**Ожидаемый результат**: Два отдельных индивидуальных события (разрыв > window_ms)

## Критерии успеха и метрики качества

### Функциональные критерии успеха

1. **Корректная идентификация**: 95%+ точность определения BaseSignals операций
2. **Эффективная группировка**: Снижение количества отображаемых операций на 30-50% в сценариях интенсивного взаимодействия
3. **Информативность резюме**: Резюме содержит всю необходимую информацию для понимания кластера
4. **Полная отключаемость**: Возможность полного отключения без влияния на систему

### Технические критерии успеха

1. **Производительность**: Накладные расходы < 5% от базового времени логирования
2. **Совместимость**: Работа со всеми существующими форматтерами без модификаций
3. **Надежность**: 0 критических ошибок, влияющих на основное логирование
4. **Сопровождаемость**: Покрытие кода тестами > 90%

### Пользовательские критерии успеха

1. **Читаемость логов**: Повышение читаемости логов при интенсивном межмодульном взаимодействии
2. **Анализ производительности**: Возможность выявления "узких мест" в межмодульном взаимодействии
3. **Диагностика**: Упрощение диагностики проблем в распределенных операциях

## Управление рисками

### Высокие риски

**Риск 1: Неточная идентификация BaseSignals операций**
- *Вероятность*: Высокая
- *Воздействие*: Критическое  
- *Митигация*: Комплексная система идентификации с несколькими критериями, тщательное тестирование

**Риск 2: Конфликт с существующими стратегиями**
- *Вероятность*: Средняя
- *Воздействие*: Высокое
- *Митигация*: Тщательное тестирование совместной работы, четкие приоритеты стратегий

### Средние риски

**Риск 3: Производительность детекции**
- *Вероятность*: Средняя
- *Воздействие*: Среднее
- *Митигация*: Профилирование, оптимизация алгоритмов, ленивая оценка

**Риск 4: Сложность конфигурации**
- *Вероятность*: Средняя  
- *Воздействие*: Низкое
- *Митигация*: Хорошие значения по умолчанию, подробная документация

### Стратегии митигации

1. **Пошаговая реализация**: Поэтапное внедрение с тестированием на каждом этапе
2. **Обширное тестирование**: Unit, integration и performance тесты
3. **Мониторинг**: Детальное логирование работы стратегии в debug режиме
4. **Откат**: Возможность быстрого отключения при проблемах

## Зависимости и интеграция

### Внешние зависимости

1. **Система мета-операций**: Стабильная работа MetaOperationDetector
2. **Форматтеры логов**: Совместимость с OperationTableFormatter
3. **Конфигурация**: Интеграция с MetaOperationConfig

### Внутренние зависимости

1. **Структуры данных**: SubOperationLog, OperationLog, MetaOperation
2. **Базовые классы**: MetaOperationStrategy
3. **Утилиты**: Система валидации конфигурации

## Следующие этапы

### Немедленные действия
1. **Валидация требований** с техническим лидом проекта
2. **Прототипирование** алгоритма идентификации BaseSignals операций
3. **Анализ производительности** существующих стратегий для базелайна

### Планирование этапа 2
1. **Детальное проектирование** архитектуры класса BaseSignalsBurstStrategy
2. **UML диаграммы** взаимодействия с существующей системой
3. **Спецификация API** и интерфейсов

---

## Заключение этапа 1

**Статус выполнения требований**:
- ✅ Документированы все функциональные требования (FR-1 до FR-5)
- ✅ Определены нефункциональные требования (производительность, надежность, совместимость)
- ✅ Проанализирована совместимость с существующими стратегиями
- ✅ Созданы базовые сценарии использования (4 детальных сценария)
- ✅ Определены критерии успеха для стратегии (функциональные, технические, пользовательские)
- ✅ Документированы предположения и ограничения архитектуры

**Готовность к этапу 2**: Все требования детализированы, архитектурные ограничения определены, базис для проектирования создан.

**Следующий этап**: [Этап 2: Архитектура и проектирование](stage_02_architecture_design.md) - разработка технической архитектуры стратегии, определение классов и интерфейсов.
